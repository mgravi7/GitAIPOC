version: '3.8'

# ============================================
# GitAIPOC - Docker Compose Configuration
# ============================================
# This compose file orchestrates:
# 1. GitLab CE (Community Edition)
# 2. GitLab AI Review Agent (gitlab-cr-agent)
# 3. Context7 MCP service (optional, for enhanced documentation validation)

networks:
  gitaipoc-network:
    driver: bridge
    name: ${DOCKER_NETWORK:-gitaipoc-network}

volumes:
  gitlab-config:
    driver: local
  gitlab-logs:
    driver: local
  gitlab-data:
    driver: local

services:
  # ==========================================
  # GitLab CE - Self-hosted Git repository
  # ==========================================
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    hostname: gitlab
    restart: unless-stopped
    
    ports:
      - "${GITLAB_HTTP_PORT:-80}:80"
      - "${GITLAB_HTTPS_PORT:-443}:443"
      - "${GITLAB_SSH_PORT:-2222}:22"
    
    volumes:
      - gitlab-config:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab
    
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url '${GITLAB_EXTERNAL_URL:-http://localhost}'
        gitlab_rails['initial_root_password'] = '${GITLAB_ROOT_PASSWORD}'
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT:-2222}
        
        # Performance optimizations for POC
        gitlab_rails['env'] = {
          'MALLOC_CONF' => 'dirty_decay_ms:1000,muzzy_decay_ms:1000'
        }
        
        # Reduce resource usage for development
        puma['worker_processes'] = 2
        sidekiq['max_concurrency'] = 10
        
        # Enable webhook debugging
        gitlab_rails['webhook_timeout'] = 30
    
    networks:
      - gitaipoc-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    
    shm_size: '256m'

  # ==========================================
  # GitLab AI Review Agent
  # ==========================================
  gitlab-ai-reviewer:
    build:
      context: ./gitlab-cr-agent
      dockerfile: Dockerfile
    container_name: gitlab-ai-reviewer
    hostname: review-agent
    restart: unless-stopped
    
    ports:
      - "8000:8000"
    
    environment:
      # GitLab Configuration
      GITLAB_URL: ${GITLAB_URL:-http://gitlab}
      GITLAB_TOKEN: ${GITLAB_TOKEN}
      GITLAB_WEBHOOK_SECRET: ${GITLAB_WEBHOOK_SECRET}
      GITLAB_TRIGGER_TAG: ${GITLAB_TRIGGER_TAG:-ai-review}
      
      # Anthropic API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      AI_MODEL: ${AI_MODEL:-anthropic:claude-sonnet-4.5-20241022}
      
      # Security
      API_KEY: ${API_KEY}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      
      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      GLOBAL_RATE_LIMIT: ${GLOBAL_RATE_LIMIT:-100/minute}
      WEBHOOK_RATE_LIMIT: ${WEBHOOK_RATE_LIMIT:-10/minute}
      MAX_REQUEST_SIZE: ${MAX_REQUEST_SIZE:-10485760}
      
      # Circuit Breaker
      CIRCUIT_BREAKER_FAILURE_THRESHOLD: ${CIRCUIT_BREAKER_FAILURE_THRESHOLD:-5}
      CIRCUIT_BREAKER_TIMEOUT: ${CIRCUIT_BREAKER_TIMEOUT:-60}
      
      # Tool System
      TOOLS_ENABLED: ${TOOLS_ENABLED:-true}
      TOOLS_PARALLEL_EXECUTION: ${TOOLS_PARALLEL_EXECUTION:-true}
      TOOLS_TIMEOUT: ${TOOLS_TIMEOUT:-30}
      CONTEXT7_ENABLED: ${CONTEXT7_ENABLED:-true}
      
      # Standards-Based Rules
      RULE_ENGINE_ENABLED: ${RULE_ENGINE_ENABLED:-true}
      RULE_CACHE_TTL: ${RULE_CACHE_TTL:-3600}
      OWASP_INTEGRATION: ${OWASP_INTEGRATION:-true}
      NIST_INTEGRATION: ${NIST_INTEGRATION:-true}
      PYTHON_STANDARDS: ${PYTHON_STANDARDS:-true}
      FRAMEWORK_STANDARDS: ${FRAMEWORK_STANDARDS:-true}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DEBUG: ${DEBUG:-false}
      
      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost,http://localhost:80}
    
    networks:
      - gitaipoc-network
    
    depends_on:
      gitlab:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "-H", "Authorization: Bearer ${API_KEY}", "http://localhost:8000/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # Context7 MCP Service (Optional)
  # ==========================================
  # Uncomment to enable Context7 for enhanced documentation validation
  # context7:
  #   image: context7/mcp-server:latest
  #   container_name: context7
  #   hostname: context7
  #   restart: unless-stopped
  #   
  #   ports:
  #     - "8080:8080"
  #   
  #   environment:
  #     CONTEXT7_MAX_TOKENS: ${CONTEXT7_MAX_TOKENS:-2000}
  #     CONTEXT7_CACHE_TTL: ${CONTEXT7_CACHE_TTL:-3600}
  #   
  #   networks:
  #     - gitaipoc-network
  #   
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

# ============================================
# USAGE INSTRUCTIONS
# ============================================
# 1. Copy .env.example to .env and configure your settings
# 2. Start all services: docker-compose up -d
# 3. Wait for GitLab to initialize (2-3 minutes)
# 4. Access GitLab: http://localhost
# 5. Configure webhook in GitLab to point to: http://review-agent:8000/webhook/gitlab
# 6. Create a merge request and add the 'ai-review' label to trigger review
#
# Common Commands:
# - Start services:        docker-compose up -d
# - Stop services:         docker-compose down
# - View logs:             docker-compose logs -f
# - Restart review agent:  docker-compose restart gitlab-ai-reviewer
# - Check status:          docker-compose ps
# - Remove all data:       docker-compose down -v (WARNING: deletes all GitLab data!)
