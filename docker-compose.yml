version: '3.8'

# ============================================
# GitAIPOC - Docker Compose Configuration
# ============================================
# This compose file orchestrates:
# 1. GitLab CE (Community Edition)
# 2. GitLab AI Review Agent (gitlab-cr-agent)
# 3. Context7 MCP service (optional, for enhanced documentation validation)

networks:
  gitaipoc-network:
    driver: bridge
    name: ${DOCKER_NETWORK:-gitaipoc-network}

volumes:
  gitlab-config:
    driver: local
  gitlab-logs:
    driver: local
  gitlab-data:
    driver: local

services:
  # ==========================================
  # GitLab CE - Self-hosted Git repository
  # ==========================================
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    hostname: gitlab
    restart: unless-stopped
    
    ports:
      - "${GITLAB_HTTP_PORT:-80}:80"
      - "${GITLAB_HTTPS_PORT:-443}:443"
      - "${GITLAB_SSH_PORT:-2222}:22"
    
    volumes:
      - gitlab-config:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab
    
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url '${GITLAB_EXTERNAL_URL:-http://localhost}'
        gitlab_rails['initial_root_password'] = "${GITLAB_ROOT_PASSWORD}"
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT:-2222}
        
        # Disable email confirmation for POC
        gitlab_rails['gitlab_email_enabled'] = false
        gitlab_rails['gitlab_email_from'] = 'gitlab@localhost'
        gitlab_rails['gitlab_email_display_name'] = 'GitLab'
        gitlab_rails['gitlab_email_reply_to'] = 'noreply@localhost'
        
        # Skip email confirmation
        gitlab_rails['omniauth_allow_single_sign_on'] = false
        gitlab_rails['block_auto_created_users'] = false
        
        # Performance optimizations for POC
        gitlab_rails['env'] = {
          'MALLOC_CONF' => 'dirty_decay_ms:1000,muzzy_decay_ms:1000'
        }
        
        # Reduce resource usage for development
        puma['worker_processes'] = 2
        sidekiq['max_concurrency'] = 10
        
        # Enable webhook debugging
        gitlab_rails['webhook_timeout'] = 30
    
    networks:
      - gitaipoc-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    
    shm_size: '256m'

  # ==========================================
  # Code Review Agent (Simple Custom Agent)
  # ==========================================
  code-review-agent:
    build:
      context: ./code-review-agent
      dockerfile: Dockerfile
    container_name: code-review-agent
    hostname: code-review-agent
    restart: unless-stopped
    
    ports:
      - "8000:8000"
    
    environment:
      # GitLab Configuration
      GITLAB_URL: ${GITLAB_URL:-http://gitlab}
      GITLAB_TOKEN: ${GITLAB_TOKEN}
      GITLAB_WEBHOOK_SECRET: ${GITLAB_WEBHOOK_SECRET}
      GITLAB_TRIGGER_LABEL: ${GITLAB_TRIGGER_LABEL:-ai-review}
      
      # Anthropic Configuration
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      ANTHROPIC_MAX_TOKENS: ${ANTHROPIC_MAX_TOKENS:-4096}
      ANTHROPIC_API_VERSION: ${ANTHROPIC_API_VERSION:-2023-06-01}
      
      # Application Configuration
      APP_HOST: 0.0.0.0
      APP_PORT: 8000
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      
      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      MAX_REVIEWS_PER_HOUR: ${MAX_REVIEWS_PER_HOUR:-50}
      
      # Review Configuration
      REVIEW_TIMEOUT: ${REVIEW_TIMEOUT:-120}
      MAX_DIFF_SIZE: ${MAX_DIFF_SIZE:-10000}
    
    networks:
      - gitaipoc-network
    
    depends_on:
      gitlab:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # Context7 MCP Service (Optional)
  # ==========================================
  # Uncomment to enable Context7 for enhanced documentation validation
  # context7:
  #   image: context7/mcp-server:latest
  #   container_name: context7
  #   hostname: context7
  #   restart: unless-stopped
  #   
  #   ports:
  #     - "8080:8080"
  #   
  #   environment:
  #     CONTEXT7_MAX_TOKENS: ${CONTEXT7_MAX_TOKENS:-2000}
  #     CONTEXT7_CACHE_TTL: ${CONTEXT7_CACHE_TTL:-3600}
  #   
  #   networks:
  #     - gitaipoc-network
  #   
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

# ============================================
# USAGE INSTRUCTIONS
# ============================================
# 1. Copy .env.example to .env and configure your settings
# 2. Start all services: docker-compose up -d
# 3. Wait for GitLab to initialize (2-3 minutes)
# 4. Access GitLab: http://localhost
# 5. Configure webhook in GitLab to point to: http://review-agent:8000/webhook/gitlab
# 6. Create a merge request and add the 'ai-review' label to trigger review
#
# Common Commands:
# - Start services:        docker-compose up -d
# - Stop services:         docker-compose down
# - View logs:             docker-compose logs -f
# - Restart review agent:  docker-compose restart gitlab-ai-reviewer
# - Check status:          docker-compose ps
# - Remove all data:       docker-compose down -v (WARNING: deletes all GitLab data!)
